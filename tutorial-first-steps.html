<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>First steps with RMC - The Rust Model Checker</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documentation for the Rust Model Checker (RMC)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting started with RMC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="install-guide.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="tool-comparison.html"><strong aria-hidden="true">1.2.</strong> Comparison with other tools</a></li><li class="chapter-item expanded "><a href="rmc-single-file.html"><strong aria-hidden="true">1.3.</strong> RMC on a single file</a></li><li class="chapter-item expanded "><a href="cargo-rmc.html"><strong aria-hidden="true">1.4.</strong> RMC on a package</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.5.</strong> Debugging failures</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.6.</strong> Debugging non-termination</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.7.</strong> Debugging coverage</div></li></ol></li><li class="chapter-item expanded "><a href="rmc-tutorial.html"><strong aria-hidden="true">2.</strong> RMC tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial-first-steps.html" class="active"><strong aria-hidden="true">2.1.</strong> First steps with RMC</a></li><li class="chapter-item expanded "><a href="tutorial-kinds-of-failure.html"><strong aria-hidden="true">2.2.</strong> Failures that RMC can spot</a></li><li class="chapter-item expanded "><a href="tutorial-loops-unwinding.html"><strong aria-hidden="true">2.3.</strong> Loops, unwinding, and bounds</a></li><li class="chapter-item expanded "><a href="tutorial-real-code.html"><strong aria-hidden="true">2.4.</strong> Where to start on real code</a></li></ol></li><li class="chapter-item expanded "><a href="dev-documentation.html"><strong aria-hidden="true">3.</strong> RMC developer documentation</a></li><li class="chapter-item expanded "><a href="dashboard.html"><strong aria-hidden="true">4.</strong> RMC dashboard</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Rust Model Checker</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/model-checking/rmc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/model-checking/rmc/edit/main/rmc-docs/src/tutorial-first-steps.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="first-steps-with-rmc"><a class="header" href="#first-steps-with-rmc">First steps with RMC</a></h1>
<blockquote>
<p>This tutorial expects you to have followed the RMC <a href="./install-guide.html">installation instructions</a> first.</p>
</blockquote>
<p>RMC is unlike the testing tools you may already be familiar with.
Much of testing is concerned with thinking of new corner cases that need to be covered.
With RMC, all the corner cases are covered from the start, and the new concern is narrowing down the scope to something manageable for the checker.</p>
<p>Consider this first program (which can be found under <a href="https://github.com/model-checking/rmc/tree/main/rmc-docs/src/tutorial/rmc-first-steps/"><code>rmc-docs/src/tutorial/rmc-first-steps</code></a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn estimate_size(x: u32) -&gt; u32 {
    if x &lt; 256 {
        if x &lt; 128 {
            return 1;
        } else {
            return 3;
        }
    } else if x &lt; 1024 {
        if x &gt; 1022 {
            panic!(&quot;Oh no, a failing corner case!&quot;);
        } else {
            return 5;
        }
    } else {
        if x &lt; 2048 {
            return 7;
        } else {
            return 9;
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Think about the test harness you would need to write to test this function.
You would need figure out a whole set of arguments to call the function with that would exercise each branch.
You would need to keep that test harness up-to-date with the code, in case some of the branches change.
And if this function was more complicated—for example, if some of the branches depended on global state—the test harness would be even more onerous to write.</p>
<p>We can try to property test a function like this, but if we're naive about it (and consider all possible <code>u32</code> inputs), then it's unlikely we'll ever find the bug.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    proptest! {
        #![proptest_config(ProptestConfig::with_cases(10000))]
        #[test]
        fn doesnt_crash(x: u32) {
            estimate_size(x);
        }
    }
<span class="boring">}
</span></code></pre></pre>
<pre><code># cargo test
[...]
test tests::doesnt_crash ... ok
</code></pre>
<p>There's only 1 in 4 billion inputs that fail, so it's vanishingly unlikely the property test will find it, even with a million samples.</p>
<p>With RMC, however:</p>
<pre><pre class="playground"><code class="language-rust">#[cfg(rmc)]
#[no_mangle]
fn main() {
    let x: u32 = __nondet();
    estimate_size(x);
}
</code></pre></pre>
<pre><code># cargo rmc
[...]
Runtime decision procedure: 0.00116886s

** Results:
./src/lib.rs function estimate_size
[estimate_size.assertion.1] line 9 Oh no, a failing corner case!: FAILURE

** 1 of 1 failed (2 iterations)
VERIFICATION FAILED
</code></pre>
<p>RMC has immediately found a failure.
Notably, we haven't had to write explicit assertions in our &quot;proof harness&quot;: by default, RMC will find a host of erroneous conditions which include a reachable call to <code>panic</code> or a failing <code>assert</code>.</p>
<h3 id="getting-a-trace"><a class="header" href="#getting-a-trace">Getting a trace</a></h3>
<p>By default, RMC only reports failures, not how the failure happened.
This is because, in its full generality, understanding how a failure happened requires exploring a full (potentially large) execution trace.
Here, we've just got some nondeterministic inputs up front, but that's something of a special case that has a &quot;simpler&quot; explanation (just the choice of nondeterministic input).</p>
<p>To see traces, run:</p>
<pre><code>rmc --visualize src/lib.rs
open report/html/index.html
</code></pre>
<p>The first command runs RMC and generates the html-based report in <code>report/</code>.
The second command opens that report in your default browser (on mac, on linux desktops try <code>xdg-open</code>).
From this report, we can find the trace of the failure and filter through it to find the relevant line (at present time, an unfortunate amount of generated code is present in the trace):</p>
<pre><code>let x: u32 = __nondet();
x = 1023u
</code></pre>
<p>Here we're seeing the line of code and the value assigned in this particular trace.
Like property testing, this is just one example of a failure.
To find more, we'd presumably fix this issue and then re-run RMC.</p>
<h3 id="exercise-try-other-failures"><a class="header" href="#exercise-try-other-failures">Exercise: Try other failures</a></h3>
<p>We put an explicit panic in this function, but it's not the only kind of failure RMC will find.
Try a few other types of errors.</p>
<p>For example, instead of panicking we could try explicitly dereferencing a null pointer:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>unsafe { return *(0 as *const u32) };
<span class="boring">}
</span></code></pre></pre>
<p>Notably, however, the Rust compiler emits a warning here:</p>
<pre><code>warning: dereferencing a null pointer
  --&gt; src/lib.rs:10:29
   |
10 |    unsafe { return *(0 as *const u32) };
   |                    ^^^^^^^^^^^^^^^^^^ this code causes undefined behavior when executed
   |
   = note: `#[warn(deref_nullptr)]` on by default
</code></pre>
<p>Still, it is just a warning, and we can run the code without test failures just as before.
But RMC still catches the issue:</p>
<pre><code>** Results:
./src/lib.rs function estimate_size
[estimate_size.pointer_dereference.1] line 10 dereference failure: pointer NULL in *var_10: FAILURE

** 1 of 1 failed (2 iterations)
VERIFICATION FAILED
</code></pre>
<p><strong>Can you find an example where the Rust compiler will not complain, and RMC will?</strong></p>
<details>
<summary>Click to show one possible answer</summary>
<pre><code>return 1 &lt;&lt; x;
</code></pre>
<p>Overflow (addition, multiplication, etc, and this case, <a href="https://github.com/rust-lang/rust/issues/10183">bitshifting by too much</a>) is also caught by RMC:</p>
<pre><code>** Results:
./src/lib.rs function estimate_size
[estimate_size.assertion.1] line 10 attempt to shift left by `move _10`, which would overflow: FAILURE
[estimate_size.undefined-shift.1] line 10 shift distance too large in 1 &lt;&lt; var_10: FAILURE

** 2 of 2 failed (2 iterations)
VERIFICATION FAILED
</code></pre>
</details>
<h2 id="assertions-assumptions-and-harnesses"><a class="header" href="#assertions-assumptions-and-harnesses">Assertions, Assumptions, and Harnesses</a></h2>
<p>It seems a bit odd that we can take billions of inputs, but our function clearly only handles up to a few thousand.
Let's codify this fact about our function by asserting some reasonable bound on our input, after we've fixed our bug:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn estimate_size(x: u32) -&gt; u32 {
    assert!(x &lt; 4096);

    if x &lt; 256 {
        if x &lt; 128 {
            return 1;
        } else {
            return 3;
        }
    } else if x &lt; 1024 {
        if x &gt; 1022 {
            return 4;
        } else {
            return 5;
        }
    } else {
        if x &lt; 2048 {
            return 7;
        } else {
            return 9;
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Now we have stated our previously implicit expectation: this function should never be called with inputs that are too big.
But if we attempt to verify this, we get a problem:</p>
<pre><code>** Results:
./tests/final-form.rs function estimate_size
[estimate_size.assertion.1] line 3 assertion failed: x &lt; 4096: FAILURE

** 1 of 1 failed (2 iterations)
VERIFICATION FAILED
</code></pre>
<p>We intended this to be a precondition of calling the function, but RMC is treating it like a failure.
If we call this function with too large of a value, it will crash with an assertion failure.
But we know that, that was our intention.</p>
<p>This is the purpose of <em>proof harnesses</em>.
Much like property testing (which would also find this assertion failure as a bug), we need to set up our preconditions, call the function in question, then assert our post conditions.
Here's a revised example of the proof harness, one that now succeeds:</p>
<pre><pre class="playground"><code class="language-rust">#[cfg(rmc)]
#[no_mangle]
fn main() {
    let x: u32 = __nondet();
    __VERIFIER_assume(x &lt; 4096);
    let y = estimate_size(x);
    assert!(y &lt; 10);
}
</code></pre></pre>
<p>But now we must wonder if we've really fully tested our function.
What if we revise the function, but forget to update the assumption in our proof harness to cover the new range of inputs?</p>
<p>Fortunately, RMC is able to report a coverage metric for each proof harness.
Try running:</p>
<pre><code>rmc --visualize tests/final-form.rs
open report/html/index.html
</code></pre>
<p>The beginning of the report includes coverage information.
Clicking through to the file will show fully-covered lines in green.
Lines not covered by our proof harness will show in red.</p>
<ol>
<li>Try changing the assumption in the proof harness to <code>x &lt; 2048</code>. Now the harness won't be testing all possible cases.</li>
<li>Rerun <code>rmc --visualize</code> on the file</li>
<li>Look at the report: you'll see we no longer have 100% coverage of the function.</li>
</ol>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>In this section:</p>
<ol>
<li>We saw RMC find panics, assertion failures, and even some other failures like unsafe dereferencing of null pointers.</li>
<li>We saw how to get a failing trace using <code>rmc --visualize</code></li>
<li>We saw how proof harnesses are used to set up preconditions and assert postconditions.</li>
<li>We saw how to obtain coverage metrics and use them to ensure our proofs are covering as much as they should be.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="rmc-tutorial.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="tutorial-kinds-of-failure.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="rmc-tutorial.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="tutorial-kinds-of-failure.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
