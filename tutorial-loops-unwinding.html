<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Loops, unwinding, and bounds - The Kani Rust Verifier</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documentation for the Kani Rust Verifier">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting started with Kani</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="install-guide.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="tool-comparison.html"><strong aria-hidden="true">1.2.</strong> Comparison with other tools</a></li><li class="chapter-item expanded "><a href="kani-single-file.html"><strong aria-hidden="true">1.3.</strong> Kani on a single file</a></li><li class="chapter-item expanded "><a href="cargo-kani.html"><strong aria-hidden="true">1.4.</strong> Kani on a package</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.5.</strong> Debugging failures</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.6.</strong> Debugging non-termination</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.7.</strong> Debugging coverage</div></li></ol></li><li class="chapter-item expanded "><a href="kani-tutorial.html"><strong aria-hidden="true">2.</strong> Kani tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial-first-steps.html"><strong aria-hidden="true">2.1.</strong> First steps with Kani</a></li><li class="chapter-item expanded "><a href="tutorial-kinds-of-failure.html"><strong aria-hidden="true">2.2.</strong> Failures that Kani can spot</a></li><li class="chapter-item expanded "><a href="tutorial-loops-unwinding.html" class="active"><strong aria-hidden="true">2.3.</strong> Loops, unwinding, and bounds</a></li><li class="chapter-item expanded "><a href="tutorial-nondeterministic-variables.html"><strong aria-hidden="true">2.4.</strong> Creating non-deterministic variables</a></li><li class="chapter-item expanded "><a href="tutorial-real-code.html"><strong aria-hidden="true">2.5.</strong> Where to start on real code</a></li></ol></li><li class="chapter-item expanded "><a href="dev-documentation.html"><strong aria-hidden="true">3.</strong> Kani developer documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kani-testing.html"><strong aria-hidden="true">3.1.</strong> Testing</a></li><li class="chapter-item expanded "><a href="bookrunner.html"><strong aria-hidden="true">3.2.</strong> Book runner</a></li></ol></li><li class="chapter-item expanded "><a href="limitations.html"><strong aria-hidden="true">4.</strong> Limitations</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Kani Rust Verifier</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/model-checking/kani" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/model-checking/kani/edit/main/kani-docs/src/tutorial-loops-unwinding.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="loops-unwinding-and-bounds"><a class="header" href="#loops-unwinding-and-bounds">Loops, unwinding, and bounds</a></h1>
<p>Consider code like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn initialize_prefix(length: usize, buffer: &amp;mut [u8]) {
    // Let's just ignore invalid calls
    if length &gt; buffer.len() {
        return;
    }

    for i in 0..=length {
        buffer[i] = 0;
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>This code has an off-by-one error that only occurs on the last iteration of the loop (when called with an input that will trigger it).
We can try to find this bug with a proof harness like this:</p>
<pre><pre class="playground"><code class="language-rust">#[cfg(kani)]
#[no_mangle]
fn main() {
    const LIMIT: usize = 10;
    let mut buffer: [u8; LIMIT] = [1; LIMIT];

    let length = kani::any();
    kani::assume(length &lt;= LIMIT);

    initialize_prefix(length, &amp;mut buffer);
}
</code></pre></pre>
<p>When we run Kani on this, we run into an unfortunate result: non-termination.
This non-termination is caused by the model checker trying to unroll the loop an unbounded number of times.</p>
<blockquote>
<p><strong>NOTE:</strong> Presently, <a href="https://github.com/model-checking/kani/issues/493">due to a bug</a>, this is especially bad: we don't see any output at all.
You are supposed to see some log lines that might give some clue that an infinite loop is occurring.
If Kani doesn't terminate, it's almost always the problem that this section is covering, however.</p>
</blockquote>
<p>To verify programs like this, we really need to do two things:</p>
<ol>
<li>Create an upper bound on the size of the problem.
We've actually already done part of this: our proof harness seems to be trying to set an upper limit of 10.</li>
<li>Tell Kani about this limit, if it's not able to figure it out on its own.</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong> In the future, Kani may eventually support specifying <em>loop invariants</em>, which allow us to do away with fixed upper bounds like this.
That support is not ready yet, however.</p>
</blockquote>
<p>Bounding proofs like this means we may no longer be proving as much as we originally hoped.
Who's to say, if we prove everything works up to size 10, that there isn't a novel bug lurking, expressible only with problems of size 11+?
But, let's get back to the practical issue at hand.</p>
<p>We can &quot;make progress&quot; in our work by giving Kani a global bound on the problem size using the <code>--unwind &lt;bound&gt;</code> flag.
This flag puts a fixed upper bound on loop unrolling.
Kani will automatically generate verification conditions that help us understand if that bound isn't enough.
Let's start with the &quot;sledge hammer&quot; by dropping all the way down to size 1:</p>
<pre><code># kani src/lib.rs --cbmc-args --unwind 1
[.unwind.0] unwinding assertion loop 0: FAILURE
VERIFICATION FAILED
</code></pre>
<blockquote>
<p><strong>NOTE:</strong> <code>--unwind</code> is a flag to the underlying model checker, CBMC, and so it needs to appear after <code>--cbmc-args</code>.
This flag <code>--cbmc-args</code> &quot;switches modes&quot; in the command line from Kani flags to CBMC flags, so we place all Kani flags and arguments before it.</p>
</blockquote>
<p>This output is showing us two things:</p>
<ol>
<li>Kani tells us we haven't unwound enough. This is the failure of the &quot;unwinding assertion.&quot;</li>
<li>We aren't seeing other failures if we only unroll the loop once.
The execution can't progress far enough to reveal the bug we're interested in (which actually only happens in the last iteration of the loop).</li>
</ol>
<p>Doing an initial <code>--unwind 1</code> is generally enough to force termination, but often too little to do any practical verification.</p>
<p>We were clearly aiming at a size limit of 10 in our proof harness, so let's try a few things here:</p>
<pre><code># kani src/lib.rs --cbmc-args --unwind 10 | grep FAIL
[.unwind.0] unwinding assertion loop 0: FAILURE
VERIFICATION FAILED
</code></pre>
<p>A bound of 10 still isn't enough because we generally need to unwind one greater than the number of executed loop iterations:</p>
<pre><code># kani src/lib.rs --cbmc-args --unwind 11 | grep FAIL
[initialize_prefix.unwind.0] line 11 unwinding assertion loop 0: FAILURE
[initialize_prefix.assertion.2] line 12 index out of bounds: the length is move _20 but the index is _19: FAILURE
[initialize_prefix.pointer_dereference.5] line 12 dereference failure: pointer outside object bounds in buffer.data[var_19]: FAILURE
VERIFICATION FAILED
</code></pre>
<p>We're still not seeing the unwinding assertion failure go away!
This is because our error is really an off by one problem, we loop one too many times, so let's add one more:</p>
<pre><code># kani src/lib.rs --cbmc-args --unwind 12 | grep FAIL
[initialize_prefix.assertion.2] line 12 index out of bounds: the length is move _20 but the index is _19: FAILURE
[initialize_prefix.pointer_dereference.5] line 12 dereference failure: pointer outside object bounds in buffer.data[var_19]: FAILURE
VERIFICATION FAILED
</code></pre>
<p>Kani is now sure we've unwound the loop enough to verify our proof harness, and now we're seeing just the bound checking failures from the off by one error.</p>
<ol>
<li>Exercise: Fix the off-by-one bounds error and get Kani to verify successfully.</li>
<li>Exercise: After fixing the error, <code>--unwind 11</code> works. Why?</li>
</ol>
<h2 id="customizing-individual-loop-bounds"><a class="header" href="#customizing-individual-loop-bounds">Customizing individual loop bounds</a></h2>
<p>Setting <code>--unwind</code> globally affects every loop.
Once you know which loop is the culprit, it can sometimes be helpful to provide specific bounds on specific loops.</p>
<p>In the general case, specifying just the highest bound globally for all loops shouldn't cause any problems, except that the solver may take more time because <em>all</em> loops will be unwound to the specified bound.</p>
<ol>
<li>Exercise: Try increasing the unwind bound on the code from the previous section and then time how long solving takes.
For example, we see 0.5s at unwinding 12, and 3s at unwinding 100.</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong> Kani does not yet support annotating code with unwinding bounds.
What follows is a hacky way to make things happen, if you need it.</p>
</blockquote>
<p>In situations where you need to optimize solving time better, specific bounds for specific loops can be provided on the command line.</p>
<pre><code># kani src/lib.rs --cbmc-args --show-loops
[...]
Loop _RNvCs6JP7pnlEvdt_3lib17initialize_prefix.0:
  file ./src/lib.rs line 11 column 5 function initialize_prefix

Loop _RNvMs8_NtNtCswN0xKFrR8r_4core3ops5rangeINtB5_14RangeInclusivejE8is_emptyCs6JP7pnlEvdt_3lib.0:
  file $RUST/library/core/src/ops/range.rs line 540 column 9 function std::ops::RangeInclusive::&lt;Idx&gt;::is_empty

Loop gen-repeat&lt;[u8; 10]::16806744624734428132&gt;.0:
</code></pre>
<p>This command shows us the mangled names of the loops involved.
Then we can specify the bound for specific loops by name, from the command line:</p>
<pre><code>kani src/lib.rs --cbmc-args --unwindset _RNvCs6JP7pnlEvdt_3lib17initialize_prefix.0:12
</code></pre>
<p>The general format of the <code>--unwindset</code> option is: <code>label_1:bound_1,label_2:bound_2,...</code>.
The label is revealed by the output of <code>--show-loops</code> as we saw above.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>In this section:</p>
<ol>
<li>We saw Kani fail to terminate.</li>
<li>We saw how <code>--unwind 1</code> can &quot;sledgehammer&quot; Kani into terminating, possibly with additional and/or missing failures.</li>
<li>We saw how &quot;unwinding assertions&quot; can warn us that we've set the unwinding limit too low.</li>
<li>We saw how to put a practical bound on problem size in our proof harness.</li>
<li>We saw how to pick an unwinding size large enough to successfully verify that bounded proof.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="tutorial-kinds-of-failure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="tutorial-nondeterministic-variables.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="tutorial-kinds-of-failure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="tutorial-nondeterministic-variables.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
